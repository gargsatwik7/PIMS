<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard</title>

  <!-- Fonts & Icons -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/particles.js@2.0.0/particles.min.js"></script>

  <style>
    * {margin:0;padding:0;box-sizing:border-box;font-family:'Poppins',sans-serif;}
    body {
      background:linear-gradient(-45deg,#1a1f36,#2a2f4a,#0f172a,#1e293b);
      background-size:400% 400%;
      animation:gradientMove 15s ease infinite;color:white;
    }
    @keyframes gradientMove {
      0%{background-position:0% 50%;}50%{background-position:100% 50%;}100%{background-position:0% 50%;}
    }
    #particles-js {position:fixed;width:100%;height:100%;z-index:-1;top:0;left:0;}
    .container {max-width:1400px;margin:auto;padding:20px;}

    /* Cards */
    .cards {display:grid;grid-template-columns:repeat(3,1fr);gap:20px;margin-bottom:20px;}
    .card {background:rgba(255,255,255,0.1);border-radius:16px;padding:20px;backdrop-filter:blur(10px);box-shadow:0 8px 32px rgba(0,0,0,0.2);transition:transform .3s,box-shadow .3s;}
    .card:hover {transform:translateY(-5px) scale(1.02);box-shadow:0 12px 40px rgba(0,0,0,0.4);}
    .card-header {display:flex;align-items:center;gap:15px;}
    .icon {width:55px;height:55px;display:flex;align-items:center;justify-content:center;border-radius:50%;font-size:22px;color:white;}
    .icon.clients {background:linear-gradient(135deg,#3b82f6,#60a5fa);}
    .icon.projects {background:linear-gradient(135deg,#10b981,#34d399);}
    .icon.team {background:linear-gradient(135deg,#f59e0b,#fbbf24);}
    .card h2 {margin:0;font-size:28px;color:#fff;}
    .card p {margin:5px 0 0;color:#d1d5db;font-weight:500;}
    .breakdown {list-style:none;margin-top:10px;}
    .breakdown li {font-size:16px;font-weight:500;color:#f3f4f6;}
    .breakdown a {color:inherit;text-decoration:none;transition:.3s;}
    .breakdown a:hover {color:#60a5fa;}

    /* Layout */
    .bottom-section {display:grid;grid-template-columns:2fr 1fr;gap:20px;margin-bottom:20px;}

    /* Table */
    .table-container {background:rgba(255,255,255,0.1);backdrop-filter:blur(10px);border-radius:16px;padding:20px;box-shadow:0 8px 32px rgba(0,0,0,0.2);}
    table {width:100%;border-collapse:collapse;margin-top:15px;}
    th,td {padding:12px;text-align:left;color:#f3f4f6;}
    th {background:rgba(255,255,255,0.1);}
    tr:hover {background:rgba(255,255,255,0.05);transition:.3s;}

    /* Buttons */
    .action-btn {background:#10b981;color:white;padding:6px 12px;border-radius:6px;text-decoration:none;font-size:14px;transition:.3s;}
    .action-btn:hover {background:#059669;}
    .edit-btn {background:#facc15;color:#000;padding:5px 10px;border-radius:6px;font-size:13px;text-decoration:none;}
    .delete-btn {background:#ef4444;color:#fff;padding:5px 10px;border-radius:6px;font-size:13px;text-decoration:none;}

    /* Status Badges */
    .status-badge {
      padding:5px 10px;border-radius:12px;font-size:13px;font-weight:bold;display:inline-flex;align-items:center;gap:5px;
    }
    .started {background:#10b98133;color:#10b981;}
    .paused {background:#fbbf2433;color:#fbbf24;}
    .resumed {background:#3b82f633;color:#3b82f6;}
    .completed {background:#22c55e33;color:#22c55e;}
    .on-hold {background:#ef444433;color:#ef4444;}

    /* Charts */
    .charts-container {background:rgba(255,255,255,0.1);border-radius:16px;padding:20px;box-shadow:0 8px 32px rgba(0,0,0,0.2);display:flex;flex-direction:column;align-items:center;gap:20px;}
    canvas {max-width:230px !important;max-height:230px !important;}

    /* Searchable Dropdown */
    #memberFilter {padding:6px;border-radius:6px;background:#2a2f4a;color:white;border:none;min-width:150px;}
    #memberSearch {padding:6px;border-radius:6px;border:none;min-width:150px;}

    @media(max-width:900px){
      .cards{grid-template-columns:1fr;}
      .bottom-section{grid-template-columns:1fr;}
    }
  </style>
</head>
<body>
<div id="particles-js"></div>
<div class="container">

  <!-- Login/Logout -->
  <div style="text-align:right;margin-bottom:10px;">
    {% if user.is_authenticated %}
      <span style="margin-right:10px;color:#d1d5db;">Welcome, {{ user.username }}</span>
      <a href="{% url 'logout' %}" style="background:#ef4444;color:white;padding:8px 15px;border-radius:6px;text-decoration:none;">Logout</a>
    {% else %}
      <a href="{% url 'login' %}" style="background:#3b82f6;color:white;padding:8px 15px;border-radius:6px;text-decoration:none;">Login</a>
    {% endif %}
  </div>

  <!-- Cards -->
  <div class="cards">
    <!-- Clients -->
    <div class="card">
      <div class="card-header"><div class="icon clients"><i class="fas fa-user-tie"></i></div>
        <div><h2><a href="/clients/" style="color:white;text-decoration:none;">{{ clients_count }}</a></h2><p>Clients</p></div></div>
      <ul class="breakdown">{% for status,count in clients_status.items %}<li><a href="/clients/?status={{ status|lower }}">{{ status }} - {{ count }}</a></li>{% endfor %}</ul>
      {% if is_admin %}
        <div style="margin-top:10px;">
          <a href="{% url 'add_client' %}" class="action-btn">‚ûï Add Client</a>
        </div>
      {% endif %}
    </div>

    <!-- Projects -->
    <div class="card">
      <div class="card-header"><div class="icon projects"><i class="fas fa-folder-open"></i></div>
        <div><h2><a href="/projects/" style="color:white;text-decoration:none;">{{ projects_count }}</a></h2><p>Projects</p></div></div>
      <ul class="breakdown">{% for status,count in projects.items %}<li><a href="/projects/?status={{ status|lower }}">{{ status }} - {{ count }}</a></li>{% endfor %}</ul>
      {% if is_admin %}
        <div style="margin-top:10px;">
          <a href="{% url 'add_project' %}" class="action-btn">‚ûï Add Project</a>
        </div>
      {% endif %}
    </div>

    <!-- Members -->
    <div class="card">
      <div class="card-header"><div class="icon team"><i class="fas fa-users"></i></div>
        <div><h2><a href="/members/" style="color:white;text-decoration:none;">{{ current_members|add:past_members }}</a></h2><p>Team Members</p></div></div>
      <ul class="breakdown"><li><a href="/members/?status=current">Current - {{ current_members }}</a></li><li><a href="/members/?status=past">Past - {{ past_members }}</a></li></ul>
      {% if is_admin %}
        <div style="margin-top:10px;">
          <a href="{% url 'add_member' %}" class="action-btn">‚ûï Add Member</a>
        </div>
      {% endif %}
    </div>
  </div>

  <!-- Member Projects -->
  <div class="bottom-section">
    <div class="table-container">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap;">
        <h3>Member - Projects (Only HOT)</h3>
        <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center;">
          <input type="text" id="memberSearch" placeholder="Search..." />
          <select id="memberFilter">
            <option value="">All Members</option>
            {% for mp in member_projects %}<option value="{{ mp.member }}">{{ mp.member }}</option>{% endfor %}
          </select>
          {% if is_admin %}<a href="{% url 'add_member_assigned' %}" class="action-btn">‚ûï Assign Project</a>{% endif %}
        </div>
      </div>
      <table id="memberTable">
        <thead><tr><th>Member</th><th>Project</th><th>Client</th>{% if is_admin %}<th>Actions</th>{% endif %}</tr></thead>
        <tbody>
          {% for mp in member_projects %}
            <tr>
              <td>{{ mp.member }}</td>
              <td>{{ mp.projects.0 }}</td>
              <td>{{ mp.clients.0 }}</td>
              {% if is_admin %}
                <td><a href="{% url 'edit_member_assigned' mp.id %}" class="edit-btn">‚úè Edit</a> <a href="{% url 'delete_member_assigned' mp.id %}" class="delete-btn">üóë Delete</a></td>
              {% endif %}
            </tr>
          {% empty %}<tr><td colspan="4" style="text-align:center;">No HOT projects found</td></tr>{% endfor %}
        </tbody>
      </table>
    </div>

    <div class="charts-container">
      <div><h4>Clients Status</h4><canvas id="clientsChart"></canvas></div>
      <div><h4>Projects Status</h4><canvas id="projectsChart"></canvas></div>
    </div>
  </div>

  <!-- Recent Activities -->
  <div class="table-container">
    <div style="display:flex;justify-content:space-between;align-items:center;">
      <h3>Recent Project Activities</h3>
      {% if is_admin %}<a href="{% url 'add_project_activity' %}" class="action-btn">‚ûï Add Activity</a>{% endif %}
    </div>
    <table>
      <thead><tr><th>Project</th><th>Client</th><th>Status</th><th>Last Updated</th>{% if is_admin %}<th>Actions</th>{% endif %}</tr></thead>
      <tbody>
        {% for activity in recent_activities %}
          <tr>
            <td>{{ activity.project.name }}</td>
            <td>{{ activity.project.client.Client_name }}</td>
            <td><span class="status-badge {{ activity.status|lower }}">{{ activity.status|title }}</span></td>
            <td>{{ activity.updated_at|timesince }} ago</td>
            {% if is_admin %}
            <td><a href="{% url 'edit_project_activity' activity.id %}" class="edit-btn">‚úè Edit</a> <a href="{% url 'delete_project_activity' activity.id %}" class="delete-btn">üóë Delete</a></td>
            {% endif %}
          </tr>
        {% empty %}<tr><td colspan="5" style="text-align:center;">No recent activities</td></tr>{% endfor %}
      </tbody>
    </table>
  </div>
</div>

<script>
  // Charts
  const clientLabels=[{% for s,c in clients_status.items %}'{{ s }}',{% endfor %}],
        clientData=[{% for s,c in clients_status.items %}{{ c }},{% endfor %}];
  new Chart(document.getElementById('clientsChart'),{type:'pie',data:{labels:clientLabels,datasets:[{data:clientData,backgroundColor:['#3b82f6','#10b981','#f59e0b']}]},options:{plugins:{legend:{labels:{color:'#fff'}}}}});

  const projectLabels=[{% for s,c in projects.items %}'{{ s }}',{% endfor %}],
        projectData=[{% for s,c in projects.items %}{{ c }},{% endfor %}];
  new Chart(document.getElementById('projectsChart'),{type:'pie',data:{labels:projectLabels,datasets:[{data:projectData,backgroundColor:['#3b82f6','#10b981','#f59e0b','#ef4444']}]},options:{plugins:{legend:{labels:{color:'#fff'}}}}});

  // Search & Filter
  const searchInput=document.getElementById('memberSearch');
  const filterSelect=document.getElementById('memberFilter');
  const table=document.getElementById('memberTable').tBodies[0];

  function filterTable(){
    const search=searchInput.value.toLowerCase();
    const filter=filterSelect.value.toLowerCase();
    Array.from(table.rows).forEach(row=>{
      const member=row.cells[0].innerText.toLowerCase();
      const text=row.innerText.toLowerCase();
      const match=(text.includes(search))&&(!filter||member===filter);
      row.style.display=match?'':'none';
    });
  }
  searchInput.addEventListener('keyup',filterTable);
  filterSelect.addEventListener('change',filterTable);

  // Particles
  particlesJS('particles-js',{particles:{number:{value:60},size:{value:3},move:{speed:1},line_linked:{enable:true,distance:150,color:'#ffffff',opacity:.3,width:1},color:{value:'#ffffff'}}});
</script>
</body>
</html>
